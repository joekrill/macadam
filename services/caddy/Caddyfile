*.localtest.me, localtest.me {
  encode zstd gzip
  tls internal

  @root host localtest.me 
  handle @root {
    handle_path /kratos/public/* {
      reverse_proxy http://kratos:4433
    }
    reverse_proxy /api/* api-server:4000
    reverse_proxy client-web:3000
  }

  # direct access to the underlying api-server
  @echo host echo.localtest.me 
	handle @echo {
		reverse_proxy echo:80
	}

  # direct access to the underlying api-server
  @api host api.localtest.me 
	handle @api {
		reverse_proxy api-server:4000
	}

  # redirect reuests that use the "www" subdomains
  @www host www.localtest.me 
  handle @www {
    redir https://localtest.me{uri}
  } 

  @mail host mail.localtest.me
	handle @mail {
		reverse_proxy mail:1080
	}

  @pgweb host pgweb.localtest.me
	handle @pgweb {
		reverse_proxy pgweb:8081
	}
  
  @storybook host storybook.localtest.me 
  handle @storybook {
    reverse_proxy client-web-storybook:6006
  }

  @glitchtip host glitchtip.localtest.me 
  handle @glitchtip {
    reverse_proxy glitchtip-web:8080 :8080 {
      lb_policy first
      lb_try_duration 5s
      fail_duration 10s
      transport http {
    		dial_timeout 600ms
	    }
    }
  }

  @kratos host kratos.localtest.me 
  handle @kratos {
    reverse_proxy kratos:4433
  }

  @kratos-admin host kratos-admin.localtest.me 
  handle @kratos-admin {
    reverse_proxy kratos:4434
  }

  @kratos-courier host kratos-courier.localtest.me 
  handle @kratos-courier {
    reverse_proxy kratos-courier:4434
  }

  @plausible host plausible.localtest.me 
  handle @plausible {
    reverse_proxy plausible:8000 :8080 {
      lb_policy first
      lb_try_duration 5s
      fail_duration 10s
      transport http {
    		dial_timeout 600ms
	    }
    }
  }

  @prometheus host prometheus.localtest.me 
  handle @prometheus {
    reverse_proxy prometheus:9090
  }

  @grafana host grafana.localtest.me 
  handle @grafana {
    reverse_proxy grafana:3000
  }

  # Fallback for otherwise unhandled domains
  handle {
		abort
	}
}

# For healthcheck and fallback 
:8080 {
  respond "ok"
}
